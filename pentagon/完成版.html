<html lang="ja"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆã‚¤ãƒ¬ãƒ“ãƒ¥ï¼ï¼</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow: hidden;
        }

        .app-container {
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .header h1 {
            color: #4a5568;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .bottom-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
            max-height: 40vh;
            overflow-y: auto;
            transform: translateY(calc(100% - 60px));
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .bottom-panel.expanded {
            transform: translateY(0);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #4a5568;
        }

        .expand-icon {
            font-size: 20px;
            color: #718096;
            transition: transform 0.3s ease;
        }

        .bottom-panel.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .toilet-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toilet-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toilet-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .toilet-name {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .toilet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .distance-time {
            color: #718096;
            font-size: 14px;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .star {
            color: #fbbf24;
            font-size: 16px;
        }

        .facilities {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .facility-tag {
            background: #e2e8f0;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .rating-input {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .rating-star {
            font-size: 24px;
            color: #e2e8f0;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .rating-star.active {
            color: #fbbf24;
        }

        .current-location-marker {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 3000;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filter-panel {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .filter-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2d3748;
        }

        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .controls {
                gap: 8px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>ğŸš» ãƒˆã‚¤ãƒ¬ãƒ“ãƒ¥ï¼ï¼</h1>
            <div class="controls">
                <button class="btn btn-primary" onclick="getCurrentLocation()">
                    ğŸ“ ç¾åœ¨åœ°
                </button>
                <button class="btn btn-secondary" onclick="openRegisterModal()">
                    â• æ–°è¦ç™»éŒ²
                </button>
                <button class="btn btn-secondary" onclick="toggleFilters()">
                    ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                </button>
            </div>
        </div>

        <div class="map-container">
            <div id="map" class="leaflet-container leaflet-touch leaflet-retina leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" tabindex="0" style="position: relative; outline-style: none;"><div class="leaflet-pane leaflet-map-pane" style="transform: translate3d(-277px, 0px, 0px);"><div class="leaflet-pane leaflet-tile-pane"><div class="leaflet-layer " style="z-index: 1; opacity: 1;"><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 17; transform: translate3d(45px, 26px, 0px) scale(0.5);"></div><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 18; transform: translate3d(323px, 110px, 0px) scale(1);"><img alt="" src="https://c.tile.openstreetmap.org/12/3637/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(60px, -32px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3638/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(316px, -32px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3637/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(60px, 224px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3638/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(316px, 224px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3636/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-196px, -32px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3639/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(572px, -32px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3636/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-196px, 224px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3639/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(572px, 224px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3638/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(316px, -288px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3638/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(316px, 480px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3637/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(60px, -288px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3639/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(572px, -288px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3637/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(60px, 480px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3639/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(572px, 480px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3640/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(828px, -32px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3640/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(828px, 224px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3636/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-196px, -288px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3640/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(828px, -288px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3636/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-196px, 480px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3640/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(828px, 480px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3635/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-452px, -32px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3641/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1084px, -32px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3635/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-452px, 224px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3641/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1084px, 224px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3635/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-452px, -288px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3641/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1084px, -288px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3635/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-452px, 480px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3641/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1084px, 480px, 0px); opacity: 1;"></div></div></div><div class="leaflet-pane leaflet-overlay-pane"></div><div class="leaflet-pane leaflet-shadow-pane"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" alt="" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(700px, 312px, 0px);"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" alt="" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(664px, 303px, 0px);"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" alt="" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(678px, 337px, 0px);"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" alt="" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(691px, 346px, 0px);"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" alt="" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(689px, 334px, 0px);"></div><div class="leaflet-pane leaflet-marker-pane"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" alt="Marker" tabindex="0" role="button" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(700px, 312px, 0px); z-index: 312;"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" alt="Marker" tabindex="0" role="button" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(664px, 303px, 0px); z-index: 303;"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" alt="Marker" tabindex="0" role="button" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(678px, 337px, 0px); z-index: 337;"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" alt="Marker" tabindex="0" role="button" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(691px, 346px, 0px); z-index: 346;"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" alt="Marker" tabindex="0" role="button" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(689px, 334px, 0px); z-index: 334;"><div class="leaflet-marker-icon current-location-marker leaflet-zoom-animated leaflet-interactive" tabindex="0" role="button" style="margin-left: -10px; margin-top: -10px; width: 20px; height: 20px; transform: translate3d(863px, 224px, 0px); z-index: 224;"></div></div><div class="leaflet-pane leaflet-tooltip-pane"></div><div class="leaflet-pane leaflet-popup-pane"></div><div class="leaflet-proxy leaflet-zoom-animated" style="transform: translate3d(931424px, 412898px, 0px) scale(2048);"></div></div><div class="leaflet-control-container"><div class="leaflet-top leaflet-left"><div class="leaflet-control-zoom leaflet-bar leaflet-control"><a class="leaflet-control-zoom-in" href="#" title="Zoom in" role="button" aria-label="Zoom in" aria-disabled="false"><span aria-hidden="true">+</span></a><a class="leaflet-control-zoom-out" href="#" title="Zoom out" role="button" aria-label="Zoom out" aria-disabled="false"><span aria-hidden="true">âˆ’</span></a></div></div><div class="leaflet-top leaflet-right"></div><div class="leaflet-bottom leaflet-left"></div><div class="leaflet-bottom leaflet-right"><div class="leaflet-control-attribution leaflet-control"><a href="https://leafletjs.com" title="A JavaScript library for interactive maps"><svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8" class="leaflet-attribution-flag"><path fill="#4C7BE1" d="M0 0h12v4H0z"></path><path fill="#FFD500" d="M0 4h12v3H0z"></path><path fill="#E0BC00" d="M0 7h12v1H0z"></path></svg> Leaflet</a> <span aria-hidden="true">|</span> Â© OpenStreetMap contributors</div></div></div></div>
        </div>

        <div class="bottom-panel" id="bottomPanel">
            <div class="panel-header" onclick="togglePanel()">
                <div class="panel-title">è¿‘ãã®ãƒˆã‚¤ãƒ¬</div>
                <div class="expand-icon">â–²</div>
            </div>
            <div class="filter-panel" id="filterPanel" style="display: none;">
                <div class="filter-title">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š</div>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterBabyBed" onchange="applyFilters()">
                        <label for="filterBabyBed">ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterMultipurpose" onchange="applyFilters()">
                        <label for="filterMultipurpose">å¤šç›®çš„ãƒˆã‚¤ãƒ¬</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterOstomy" onchange="applyFilters()">
                        <label for="filterOstomy">ã‚ªã‚¹ãƒˆãƒ¡ã‚¤ãƒˆ</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterHandDryer" onchange="applyFilters()">
                        <label for="filterHandDryer">ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼</label>
                    </div>
                </div>
            </div>
            <div class="toilet-list" id="toiletList">
                <div class="toilet-item" onclick="showToiletDetail(1)">
                    <div class="toilet-name">æ±äº¬é§…ä¸¸ã®å†…å—å£ãƒˆã‚¤ãƒ¬</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            5732mãƒ»å¾’æ­©72åˆ†
                        </div>
                        <div class="rating">
                            <span class="star">â˜…</span>
                            <span>4.2</span>
                        </div>
                    </div>
                    <div class="facilities">
                        <span class="facility-tag">ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰</span><span class="facility-tag">å¤šç›®çš„ãƒˆã‚¤ãƒ¬</span><span class="facility-tag">ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼</span><span class="facility-tag">è»Šæ¤…å­å¯¾å¿œ</span>
                    </div>
                </div>
            
                <div class="toilet-item" onclick="showToiletDetail(5)">
                    <div class="toilet-name">æœ‰æ¥½ç”ºé§…å‰ãƒˆã‚¤ãƒ¬</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            6379mãƒ»å¾’æ­©80åˆ†
                        </div>
                        <div class="rating">
                            <span class="star">â˜…</span>
                            <span>3.5</span>
                        </div>
                    </div>
                    <div class="facilities">
                        <span class="facility-tag">å¤šç›®çš„ãƒˆã‚¤ãƒ¬</span><span class="facility-tag">ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼</span>
                    </div>
                </div>
            
                <div class="toilet-item" onclick="showToiletDetail(4)">
                    <div class="toilet-name">éŠ€åº§ä¸‰è¶Šãƒˆã‚¤ãƒ¬</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            6524mãƒ»å¾’æ­©82åˆ†
                        </div>
                        <div class="rating">
                            <span class="star">â˜…</span>
                            <span>4.5</span>
                        </div>
                    </div>
                    <div class="facilities">
                        <span class="facility-tag">ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰</span><span class="facility-tag">å¤šç›®çš„ãƒˆã‚¤ãƒ¬</span><span class="facility-tag">ã‚ªã‚¹ãƒˆãƒ¡ã‚¤ãƒˆ</span><span class="facility-tag">ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼</span><span class="facility-tag">ã‚¦ã‚©ã‚·ãƒ¥ãƒ¬ãƒƒãƒˆ</span>
                    </div>
                </div>
            
                <div class="toilet-item" onclick="showToiletDetail(2)">
                    <div class="toilet-name">çš‡å±…å¤–è‹‘å…¬è¡†ãƒˆã‚¤ãƒ¬</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            6618mãƒ»å¾’æ­©83åˆ†
                        </div>
                        <div class="rating">
                            <span class="star">â˜…</span>
                            <span>3.8</span>
                        </div>
                    </div>
                    <div class="facilities">
                        <span class="facility-tag">å¤šç›®çš„ãƒˆã‚¤ãƒ¬</span><span class="facility-tag">è»Šæ¤…å­å¯¾å¿œ</span>
                    </div>
                </div>
            
                <div class="toilet-item" onclick="showToiletDetail(3)">
                    <div class="toilet-name">æ—¥æ¯”è°·å…¬åœ’ãƒˆã‚¤ãƒ¬</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            6717mãƒ»å¾’æ­©84åˆ†
                        </div>
                        <div class="rating">
                            <span class="star">â˜…</span>
                            <span>4.0</span>
                        </div>
                    </div>
                    <div class="facilities">
                        <span class="facility-tag">ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰</span><span class="facility-tag">ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼</span><span class="facility-tag">ã‚¦ã‚©ã‚·ãƒ¥ãƒ¬ãƒƒãƒˆ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æ–°ã—ã„ãƒˆã‚¤ãƒ¬ã‚’ç™»éŒ²</div>
                <button class="close-btn" onclick="closeRegisterModal()">Ã—</button>
            </div>
            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label">ãƒˆã‚¤ãƒ¬åç§°</label>
                    <input type="text" class="form-input" id="toiletName" placeholder="ä¾‹ï¼šâ—‹â—‹é§…æ§‹å†…ãƒˆã‚¤ãƒ¬" required="">
                </div>
                <div class="form-group">
                    <label class="form-label">ä½æ‰€</label>
                    <input type="text" class="form-input" id="toiletAddress" placeholder="ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                </div>
                <div class="form-group">
                    <label class="form-label">è¨­å‚™</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="regBabyBed">
                            <label for="regBabyBed">ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="regMultipurpose">
                            <label for="regMultipurpose">å¤šç›®çš„ãƒˆã‚¤ãƒ¬</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="regOstomy">
                            <label for="regOstomy">ã‚ªã‚¹ãƒˆãƒ¡ã‚¤ãƒˆ</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="regHandDryer">
                            <label for="regHandDryer">ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="regWheelchair">
                            <label for="regWheelchair">è»Šæ¤…å­å¯¾å¿œ</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="regBidet">
                            <label for="regBidet">ã‚¦ã‚©ã‚·ãƒ¥ãƒ¬ãƒƒãƒˆ</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æ¸…æ½”åº¦è©•ä¾¡</label>
                    <div class="rating-input" id="cleanlinessRating">
                        <span class="rating-star" data-rating="1">â˜…</span>
                        <span class="rating-star" data-rating="2">â˜…</span>
                        <span class="rating-star" data-rating="3">â˜…</span>
                        <span class="rating-star" data-rating="4">â˜…</span>
                        <span class="rating-star" data-rating="5">â˜…</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
                    <textarea class="form-input" id="toiletComment" rows="3" placeholder="ãƒˆã‚¤ãƒ¬ã®çŠ¶æ³ã‚„ç‰¹å¾´ã‚’ãŠèã‹ã›ãã ã•ã„"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
                    ç™»éŒ²ã™ã‚‹
                </button>
            </form>
        </div>
    </div>

    <!-- ãƒˆã‚¤ãƒ¬è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="detailTitle">ãƒˆã‚¤ãƒ¬è©³ç´°</div>
                <button class="close-btn" onclick="closeDetailModal()">Ã—</button>
            </div>
            <div id="detailContent">
                <!-- ãƒˆã‚¤ãƒ¬è©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let map;
        let currentLocationMarker;
        let currentPosition = null;
        let toiletMarkers = [];
        let toilets = [];
        let tempMarker = null;
        let selectedRating = 0;

        // â˜… add: åœ°å›³ã® bbox ã‹ã‚‰ amenity=toilets ã‚’å–ã£ã¦ãã‚‹
        async function pullToiletsFromOSM() {
            // ç”»é¢ã«æ˜ ã£ã¦ã„ã‚‹ç¯„å›²ã‚’ bbox æ–‡å­—åˆ—ï¼ˆå—,è¥¿,åŒ—,æ±ï¼‰ã«
            const b = map.getBounds();
            const bbox = `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`;
            

            // OverpassQL
            const query = `
            [out:json][timeout:25];
            (
                node["amenity"="toilets"](${bbox});
                way["amenity"="toilets"](${bbox});
                relation["amenity"="toilets"](${bbox});
            );
            out center;`;

            const url  = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);
            console.log(url);
            const res  = await fetch(url);
            const data = await res.json();

            // OSM â†’ æ—¢å­˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
            return data.elements.map((el) => {
                const lat  = el.lat ?? el.center?.lat;
                const lng  = el.lon ?? el.center?.lon;
                const tags = el.tags ?? {};
                console.log(tags);

                return {
                    id:   el.id,
                    name: tags.name ?? 'å…¬å…±ãƒˆã‚¤ãƒ¬',
                    lat, lng,
                    address: tags['full'] || tags['street'] || 'ä½æ‰€ä¸æ˜',
                    facilities: [
                        ...(tags.changing_table        === 'yes' ? ['ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰']      : []),
                        ...(tags['wheelchair'] === 'yes' ? ['å¤šç›®çš„ãƒˆã‚¤ãƒ¬']     : []),
                        ...(tags['ostomy']     === 'yes' ? ['ã‚ªã‚¹ãƒˆãƒ¡ã‚¤ãƒˆ']     : []),
                        ...(tags.hand_dryer            === 'yes' ? ['ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼'] : [])
                    ],
                    rating:      3.0,   // OSM ã«ã¯è©•ä¾¡ãŒç„¡ã„ã®ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    cleanliness: 3,
                    comments:    []
                };
            });
        }


        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
        const sampleToilets = [
            {
                id: 1,
                name: "æ±äº¬é§…ä¸¸ã®å†…å—å£ãƒˆã‚¤ãƒ¬",
                lat: 35.6812,
                lng: 139.7671,
                address: "æ±äº¬éƒ½åƒä»£ç”°åŒºä¸¸ã®å†…1-9-1",
                facilities: ["ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰", "å¤šç›®çš„ãƒˆã‚¤ãƒ¬", "ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼", "è»Šæ¤…å­å¯¾å¿œ"],
                rating: 4.2,
                cleanliness: 4,
                comments: ["æ¸…æ½”ã§ä½¿ã„ã‚„ã™ã„", "æ··é›‘ã—ã¦ã„ã‚‹æ™‚é–“å¸¯ãŒã‚ã‚‹"]
            },
            {
                id: 2,
                name: "çš‡å±…å¤–è‹‘å…¬è¡†ãƒˆã‚¤ãƒ¬",
                lat: 35.6838,
                lng: 139.7548,
                address: "æ±äº¬éƒ½åƒä»£ç”°åŒºçš‡å±…å¤–è‹‘",
                facilities: ["å¤šç›®çš„ãƒˆã‚¤ãƒ¬", "è»Šæ¤…å­å¯¾å¿œ"],
                rating: 3.8,
                cleanliness: 3,
                comments: ["æ™¯è‰²ãŒè‰¯ã„å ´æ‰€ã«ã‚ã‚‹"]
            },
            {
                id: 3,
                name: "æ—¥æ¯”è°·å…¬åœ’ãƒˆã‚¤ãƒ¬",
                lat: 35.6743,
                lng: 139.7594,
                address: "æ±äº¬éƒ½åƒä»£ç”°åŒºæ—¥æ¯”è°·å…¬åœ’1-6",
                facilities: ["ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰", "ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼", "ã‚¦ã‚©ã‚·ãƒ¥ãƒ¬ãƒƒãƒˆ"],
                rating: 4.0,
                cleanliness: 4,
                comments: ["å…¬åœ’å†…ã§ä¾¿åˆ©", "æ¸…æ½”ã«ä¿ãŸã‚Œã¦ã„ã‚‹"]
            },
            {
                id: 4,
                name: "éŠ€åº§ä¸‰è¶Šãƒˆã‚¤ãƒ¬",
                lat: 35.6719,
                lng: 139.7639,
                address: "æ±äº¬éƒ½ä¸­å¤®åŒºéŠ€åº§4-6-16",
                facilities: ["ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰", "å¤šç›®çš„ãƒˆã‚¤ãƒ¬", "ã‚ªã‚¹ãƒˆãƒ¡ã‚¤ãƒˆ", "ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼", "ã‚¦ã‚©ã‚·ãƒ¥ãƒ¬ãƒƒãƒˆ"],
                rating: 4.5,
                cleanliness: 5,
                comments: ["ã¨ã¦ã‚‚æ¸…æ½”", "è¨­å‚™ãŒå……å®Ÿã—ã¦ã„ã‚‹"]
            },
            {
                id: 5,
                name: "æœ‰æ¥½ç”ºé§…å‰ãƒˆã‚¤ãƒ¬",
                lat: 35.6751,
                lng: 139.7632,
                address: "æ±äº¬éƒ½åƒä»£ç”°åŒºæœ‰æ¥½ç”º2-7-1",
                facilities: ["å¤šç›®çš„ãƒˆã‚¤ãƒ¬", "ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼"],
                rating: 3.5,
                cleanliness: 3,
                comments: ["é§…å‰ã§ä¾¿åˆ©", "æ··é›‘ã™ã‚‹ã“ã¨ãŒã‚ã‚‹"]
            }
        ];


        
        // åˆæœŸåŒ–
        async function initMap() {
            // åœ°å›³ã®åˆæœŸåŒ–ï¼ˆæ±äº¬é§…ã‚’ä¸­å¿ƒã«ï¼‰
            map = L.map('map').setView([35.6812, 139.7671], 15);

            // OpenStreetMapã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);


            // â˜… æœ€åˆã®èª­ã¿è¾¼ã¿
            toilets = await pullToiletsFromOSM();
            addToiletMarkers();
            updateNearbyToilets();

                // â˜… åœ°å›³ç§»å‹•ã”ã¨ã«å†å–å¾—ï¼ˆé€£ç¶šå‘¼ã³å‡ºã—é˜²æ­¢ãªã‚‰ debounce ã™ã‚‹ï¼‰
            map.on('moveend', async () => {
                toilets = await pullToiletsFromOSM();
                addToiletMarkers();
                updateNearbyToilets();
            });

            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿ã€ãªã‘ã‚Œã°ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
            const savedToilets = localStorage.getItem('toilets');
            if (savedToilets) {
                toilets = JSON.parse(savedToilets);
            } else {
                toilets = [...sampleToilets];
                saveToilets();
            }

            // ãƒˆã‚¤ãƒ¬ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ 
            addToiletMarkers();

            // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            map.on('click', onMapClick);

            // ç¾åœ¨åœ°ã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’è¨­å®šï¼‰
            setTimeout(() => {
                getCurrentLocation();
            }, 500);
        }

        // ç¾åœ¨åœ°å–å¾—
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚\nãƒ‡ãƒ¢ç”¨ã«æ±äº¬é§…å‘¨è¾ºã‚’è¡¨ç¤ºã—ã¾ã™ã€‚');
                setDefaultLocation();
                return;
            }

            showLoading();
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    hideLoading();
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                    }
                    
                    const currentLocationIcon = L.divIcon({
                        className: 'current-location-marker',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    currentLocationMarker = L.marker([currentPosition.lat, currentPosition.lng], {
                        icon: currentLocationIcon
                    }).addTo(map);
                    
                    // åœ°å›³ã‚’ç¾åœ¨åœ°ã«ç§»å‹•
                    map.setView([currentPosition.lat, currentPosition.lng], 16);
                    
                    // è¿‘ãã®ãƒˆã‚¤ãƒ¬ã‚’æ›´æ–°
                    updateNearbyToilets();
                },
                (error) => {
                    hideLoading();
                    let errorMessage = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "ä½ç½®æƒ…å ±ã®ä½¿ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚\nãƒ‡ãƒ¢ç”¨ã«æ±äº¬é§…å‘¨è¾ºã‚’è¡¨ç¤ºã—ã¾ã™ã€‚";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚\nãƒ‡ãƒ¢ç”¨ã«æ±äº¬é§…å‘¨è¾ºã‚’è¡¨ç¤ºã—ã¾ã™ã€‚";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚\nãƒ‡ãƒ¢ç”¨ã«æ±äº¬é§…å‘¨è¾ºã‚’è¡¨ç¤ºã—ã¾ã™ã€‚";
                            break;
                        default:
                            errorMessage = "ä½ç½®æƒ…å ±ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nãƒ‡ãƒ¢ç”¨ã«æ±äº¬é§…å‘¨è¾ºã‚’è¡¨ç¤ºã—ã¾ã™ã€‚";
                            break;
                    }
                    
                    alert(errorMessage);
                    console.error('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:', error);
                    setDefaultLocation();
                },
                options
            );
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’è¨­å®šï¼ˆæ±äº¬é§…ï¼‰
        function setDefaultLocation() {
            currentPosition = {
                lat: 35.6812,
                lng: 139.7671
            };
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            
            const defaultLocationIcon = L.divIcon({
                className: 'current-location-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                html: '<div style="background: #f56565; width: 20px; height: 20px; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);"></div>'
            });
            
            currentLocationMarker = L.marker([currentPosition.lat, currentPosition.lng], {
                icon: defaultLocationIcon
            }).addTo(map);
            
            currentLocationMarker.bindPopup("ãƒ‡ãƒ¢ä½ç½®ï¼ˆæ±äº¬é§…ï¼‰").openPopup();
            
            // åœ°å›³ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã«ç§»å‹•
            map.setView([currentPosition.lat, currentPosition.lng], 16);
            
            // è¿‘ãã®ãƒˆã‚¤ãƒ¬ã‚’æ›´æ–°
            updateNearbyToilets();
        }

        // ãƒˆã‚¤ãƒ¬ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ 
        function addToiletMarkers() {
            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            toiletMarkers.forEach(marker => map.removeLayer(marker));
            toiletMarkers = [];

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            const filteredToilets = getFilteredToilets();

            filteredToilets.forEach(toilet => {
                const marker = L.marker([toilet.lat, toilet.lng]).addTo(map);
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è¨­å®š
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 8px 0; color: #2d3748;">${toilet.name}</h3>
                        <p style="margin: 0 0 8px 0; color: #718096; font-size: 14px;">${toilet.address}</p>
                        <div style="margin-bottom: 8px;">
                            <span style="color: #fbbf24;">â˜…</span> ${toilet.rating.toFixed(1)}
                        </div>
                        <div style="margin-bottom: 12px;">
                            ${toilet.facilities.map(f => `<span style="background: #e2e8f0; color: #4a5568; padding: 2px 6px; border-radius: 8px; font-size: 12px; margin-right: 4px;">${f}</span>`).join('')}
                        </div>
                        <button onclick="showToiletDetail(${toilet.id})" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; width: 100%;">è©³ç´°ã‚’è¦‹ã‚‹</button>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                toiletMarkers.push(marker);
            });
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function getFilteredToilets() {
            const filters = {
                babyBed: document.getElementById('filterBabyBed').checked,
                multipurpose: document.getElementById('filterMultipurpose').checked,
                ostomy: document.getElementById('filterOstomy').checked,
                handDryer: document.getElementById('filterHandDryer').checked
            };

            return toilets.filter(toilet => {
                if (filters.babyBed && !toilet.facilities.includes('ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰')) return false;
                if (filters.multipurpose && !toilet.facilities.includes('å¤šç›®çš„ãƒˆã‚¤ãƒ¬')) return false;
                if (filters.ostomy && !toilet.facilities.includes('ã‚ªã‚¹ãƒˆãƒ¡ã‚¤ãƒˆ')) return false;
                if (filters.handDryer && !toilet.facilities.includes('ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼')) return false;
                return true;
            });
        }

        // è¿‘ãã®ãƒˆã‚¤ãƒ¬ã‚’æ›´æ–°
        function updateNearbyToilets() {
            // ç¾åœ¨ä½ç½®ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯å…¨ã¦ã®ãƒˆã‚¤ãƒ¬ã‚’è¡¨ç¤º
            if (!currentPosition) {
                const filteredToilets = getFilteredToilets();
                displayToiletList(filteredToilets.slice(0, 5));
                return;
            }

            const filteredToilets = getFilteredToilets();
            
            // è·é›¢ã‚’è¨ˆç®—
            const toiletsWithDistance = filteredToilets.map(toilet => {
                const distance = calculateDistance(
                    currentPosition.lat, currentPosition.lng,
                    toilet.lat, toilet.lng
                );
                return {
                    ...toilet,
                    distance: distance,
                    walkingTime: Math.ceil(distance / 80) // æ™‚é€Ÿ4.8kmï¼ˆ80m/åˆ†ï¼‰ã§è¨ˆç®—
                };
            });

            // è·é›¢ã§ã‚½ãƒ¼ãƒˆ
            toiletsWithDistance.sort((a, b) => a.distance - b.distance);

            // 500mä»¥å†…ã®ãƒˆã‚¤ãƒ¬ã€ã¾ãŸã¯æœ€ä½5å€‹ã®ãƒˆã‚¤ãƒ¬ã‚’è¡¨ç¤º
            const nearbyToilets = toiletsWithDistance.filter(t => t.distance <= 500);
            const displayToilets = nearbyToilets.length >= 5 ? nearbyToilets : toiletsWithDistance.slice(0, 5);

            displayToiletList(displayToilets);
        }

        // ãƒˆã‚¤ãƒ¬ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function displayToiletList(toilets) {
            const toiletList = document.getElementById('toiletList');
            
            if (toilets.length === 0) {
                toiletList.innerHTML = '<p style="text-align: center; color: #718096;">è¿‘ãã«ãƒˆã‚¤ãƒ¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                return;
            }

            toiletList.innerHTML = toilets.map(toilet => `
                <div class="toilet-item" onclick="showToiletDetail(${toilet.id})">
                    <div class="toilet-name">${toilet.name}</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            ${toilet.distance ? `${toilet.distance}mãƒ»å¾’æ­©${toilet.walkingTime}åˆ†` : ''}
                        </div>
                        <div class="rating">
                            <span class="star">â˜…</span>
                            <span>${toilet.rating.toFixed(1)}</span>
                        </div>
                    </div>
                    <div class="facilities">
                        ${toilet.facilities.map(facility => `<span class="facility-tag">${facility}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // è·é›¢è¨ˆç®—ï¼ˆHaversineå…¬å¼ï¼‰
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // åœ°çƒã®åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return Math.round(R * c);
        }

        // ãƒ‘ãƒãƒ«ã®é–‹é–‰
        function togglePanel() {
            const panel = document.getElementById('bottomPanel');
            panel.classList.toggle('expanded');
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
        function toggleFilters() {
            const filterPanel = document.getElementById('filterPanel');
            filterPanel.style.display = filterPanel.style.display === 'none' ? 'block' : 'none';
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function applyFilters() {
            addToiletMarkers();
            updateNearbyToilets();
        }

        // åœ°å›³ã‚¯ãƒªãƒƒã‚¯
        function onMapClick(e) {
            // æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿å‡¦ç†
            if (document.getElementById('registerModal').classList.contains('active')) {
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }
                tempMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
            }
        }

        // æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openRegisterModal() {
            document.getElementById('registerModal').classList.add('active');
            // è©•ä¾¡ã®åˆæœŸåŒ–
            selectedRating = 0;
            updateRatingDisplay();
        }

        // æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('active');
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
            document.getElementById('registerForm').reset();
            selectedRating = 0;
            updateRatingDisplay();
        }

        // ãƒˆã‚¤ãƒ¬è©³ç´°ã‚’è¡¨ç¤º
        function showToiletDetail(toiletId) {
            const toilet = toilets.find(t => t.id === toiletId);
            if (!toilet) return;

            document.getElementById('detailTitle').textContent = toilet.name;
            
            const distance = currentPosition ? calculateDistance(
                currentPosition.lat, currentPosition.lng,
                toilet.lat, toilet.lng
            ) : null;
            
            const walkingTime = distance ? Math.ceil(distance / 80) : null;

            document.getElementById('detailContent').innerHTML = `
                <div style="margin-bottom: 16px;">
                    <h3 style="color: #2d3748; margin-bottom: 8px;">åŸºæœ¬æƒ…å ±</h3>
                    <p><strong>ä½æ‰€:</strong> ${toilet.address}</p>
                    ${distance ? `<p><strong>è·é›¢:</strong> ${distance}mï¼ˆå¾’æ­©ç´„${walkingTime}åˆ†ï¼‰</p>` : ''}
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                        <span style="color: #fbbf24; font-size: 18px;">â˜…</span>
                        <span style="font-size: 16px; font-weight: 600;">${toilet.rating.toFixed(1)}</span>
                        <span style="color: #718096;">ï¼ˆæ¸…æ½”åº¦: ${toilet.cleanliness}/5ï¼‰</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <h3 style="color: #2d3748; margin-bottom: 8px;">è¨­å‚™</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${toilet.facilities.map(facility => `
                            <span style="background: #e2e8f0; color: #4a5568; padding: 6px 12px; border-radius: 12px; font-size: 14px;">
                                ${facility}
                            </span>
                        `).join('')}
                    </div>
                </div>
                
                ${toilet.comments && toilet.comments.length > 0 ? `
                    <div style="margin-bottom: 16px;">
                        <h3 style="color: #2d3748; margin-bottom: 8px;">ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
                        ${toilet.comments.map(comment => `
                            <div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #667eea;">
                                ${comment}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div style="display: flex; gap: 8px; margin-top: 20px;">
                    <button onclick="openNavigationApp(${toilet.lat}, ${toilet.lng})" 
                            style="flex: 1; background: #48bb78; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        ğŸ§­ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
                    </button>
                    <button onclick="reportIssue(${toilet.id})" 
                            style="flex: 1; background: #ed8936; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        âš ï¸ å•é¡Œã‚’å ±å‘Š
                    </button>
                </div>
            `;
            
            document.getElementById('detailModal').classList.add('active');
        }

        // ãƒˆã‚¤ãƒ¬è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ—ãƒªã‚’é–‹ã
        function openNavigationApp(lat, lng) {
            // Google Mapsã§é–‹ã
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // å•é¡Œã‚’å ±å‘Š
        function reportIssue(toiletId) {
            const issues = [
                'ãƒˆã‚¤ãƒ¬ãŒè¦‹ã¤ã‹ã‚‰ãªã„',
                'ãƒˆã‚¤ãƒ¬ãŒä½¿ç”¨ã§ããªã„',
                'ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰ãŒãªã„/æ•…éšœ',
                'ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼ãŒæ•…éšœ',
                'æ¸…æ½”åº¦ãŒä½ã„',
                'ãã®ä»–ã®å•é¡Œ'
            ];
            
            const selectedIssue = prompt(`å ±å‘Šã™ã‚‹å•é¡Œã‚’é¸ã‚“ã§ãã ã•ã„:\n${issues.map((issue, index) => `${index + 1}. ${issue}`).join('\n')}\n\nç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1-${issues.length}):`);
            
            if (selectedIssue && selectedIssue >= 1 && selectedIssue <= issues.length) {
                alert(`ã€Œ${issues[selectedIssue - 1]}ã€ã®å ±å‘Šã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚`);
                // å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ã€ã“ã“ã§ã‚µãƒ¼ãƒãƒ¼ã«å ±å‘Šã‚’é€ä¿¡
            }
        }

        // è©•ä¾¡æ˜Ÿã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            const ratingStars = document.querySelectorAll('.rating-star');
            ratingStars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateRatingDisplay();
                });
            });
        });

        function updateRatingDisplay() {
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach((star, index) => {
                if (index < selectedRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('registerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!tempMarker) {
                    alert('ç™»éŒ²å®Œäº†ï¼ï¼ï¼ï¼');
                    return;
                }
                
                const formData = new FormData(this);
                const facilities = [];
                
                // è¨­å‚™æƒ…å ±ã‚’å–å¾—
                if (document.getElementById('regBabyBed').checked) facilities.push('ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰');
                if (document.getElementById('regMultipurpose').checked) facilities.push('å¤šç›®çš„ãƒˆã‚¤ãƒ¬');
                if (document.getElementById('regOstomy').checked) facilities.push('ã‚ªã‚¹ãƒˆãƒ¡ã‚¤ãƒˆ');
                if (document.getElementById('regHandDryer').checked) facilities.push('ãƒãƒ³ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ¤ãƒ¼');
                if (document.getElementById('regWheelchair').checked) facilities.push('è»Šæ¤…å­å¯¾å¿œ');
                if (document.getElementById('regBidet').checked) facilities.push('ã‚¦ã‚©ã‚·ãƒ¥ãƒ¬ãƒƒãƒˆ');
                
                const newToilet = {
                    id: Date.now(), // ç°¡æ˜“IDç”Ÿæˆ
                    name: document.getElementById('toiletName').value,
                    lat: tempMarker.getLatLng().lat,
                    lng: tempMarker.getLatLng().lng,
                    address: document.getElementById('toiletAddress').value || 'ä½æ‰€ä¸æ˜',
                    facilities: facilities,
                    rating: selectedRating || 3,
                    cleanliness: selectedRating || 3,
                    comments: document.getElementById('toiletComment').value ? [document.getElementById('toiletComment').value] : []
                };
                
                // ãƒˆã‚¤ãƒ¬ã‚’è¿½åŠ 
                toilets.push(newToilet);
                saveToilets();
                
                // åœ°å›³ã‚’æ›´æ–°
                addToiletMarkers();
                updateNearbyToilets();
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeRegisterModal();
                
                alert('æ–°ã—ã„ãƒˆã‚¤ãƒ¬ãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸï¼');
            });
        });

        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        function saveToilets() {
            localStorage.setItem('toilets', JSON.stringify(toilets));
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º/éè¡¨ç¤º
        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'registerModal') {
                    closeRegisterModal();
                } else if (e.target.id === 'detailModal') {
                    closeDetailModal();
                }
            }
        });

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('registerModal').classList.contains('active')) {
                    closeRegisterModal();
                }
                if (document.getElementById('detailModal').classList.contains('active')) {
                    closeDetailModal();
                }
            }
        });

        // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
        function handleResize() {
            if (map) {
                map.invalidateSize();
            }
        }

        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', function() {
            setTimeout(handleResize, 500);
        });
    </script>

</body></html>
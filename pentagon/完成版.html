<html lang="ja"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éà„Ç§„É¨„Éì„É•ÔºÅÔºÅ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow: hidden;
        }

        .app-container {
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .header h1 {
            color: #4a5568;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .bottom-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
            max-height: 40vh;
            overflow-y: auto;
            transform: translateY(calc(100% - 60px));
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .bottom-panel.expanded {
            transform: translateY(0);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #4a5568;
        }

        .expand-icon {
            font-size: 20px;
            color: #718096;
            transition: transform 0.3s ease;
        }

        .bottom-panel.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .toilet-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toilet-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toilet-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .toilet-name {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .toilet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .distance-time {
            color: #718096;
            font-size: 14px;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .star {
            color: #fbbf24;
            font-size: 16px;
        }

        .facilities {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .facility-tag {
            background: #e2e8f0;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .rating-input {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .rating-star {
            font-size: 24px;
            color: #e2e8f0;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .rating-star.active {
            color: #fbbf24;
        }

        .current-location-marker {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 3000;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filter-panel {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .filter-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2d3748;
        }

        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .controls {
                gap: 8px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>üöª „Éà„Ç§„É¨„Éì„É•ÔºÅÔºÅ</h1>
            <div class="controls">
                <button class="btn btn-primary" onclick="getCurrentLocation()">
                    üìç ÁèæÂú®Âú∞
                </button>
                <button class="btn btn-secondary" onclick="openRegisterModal()">
                    ‚ûï Êñ∞Ë¶èÁôªÈå≤
                </button>
                <button class="btn btn-secondary" onclick="toggleFilters()">
                    üîç „Éï„Ç£„É´„Çø„Éº
                </button>
            </div>
        </div>

        <div class="map-container">
            <div id="map" class="leaflet-container leaflet-touch leaflet-retina leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" tabindex="0" style="position: relative; outline-style: none;"><div class="leaflet-pane leaflet-map-pane" style="transform: translate3d(-277px, 0px, 0px);"><div class="leaflet-pane leaflet-tile-pane"><div class="leaflet-layer " style="z-index: 1; opacity: 1;"><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 17; transform: translate3d(45px, 26px, 0px) scale(0.5);"></div><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 18; transform: translate3d(323px, 110px, 0px) scale(1);"><img alt="" src="https://c.tile.openstreetmap.org/12/3637/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(60px, -32px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3638/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(316px, -32px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3637/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(60px, 224px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3638/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(316px, 224px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3636/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-196px, -32px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3639/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(572px, -32px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3636/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-196px, 224px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3639/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(572px, 224px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3638/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(316px, -288px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3638/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(316px, 480px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3637/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(60px, -288px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3639/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(572px, -288px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3637/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(60px, 480px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3639/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(572px, 480px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3640/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(828px, -32px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3640/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(828px, 224px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3636/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-196px, -288px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3640/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(828px, -288px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3636/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-196px, 480px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3640/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(828px, 480px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3635/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-452px, -32px, 0px); opacity: 1;"><img alt="" src="https://a.tile.openstreetmap.org/12/3641/1612.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1084px, -32px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3635/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-452px, 224px, 0px); opacity: 1;"><img alt="" src="https://b.tile.openstreetmap.org/12/3641/1613.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1084px, 224px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3635/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-452px, -288px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3641/1611.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1084px, -288px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3635/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-452px, 480px, 0px); opacity: 1;"><img alt="" src="https://c.tile.openstreetmap.org/12/3641/1614.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(1084px, 480px, 0px); opacity: 1;"></div></div></div><div class="leaflet-pane leaflet-overlay-pane"></div><div class="leaflet-pane leaflet-shadow-pane"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" alt="" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(700px, 312px, 0px);"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" alt="" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(664px, 303px, 0px);"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" alt="" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(678px, 337px, 0px);"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" alt="" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(691px, 346px, 0px);"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" alt="" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(689px, 334px, 0px);"></div><div class="leaflet-pane leaflet-marker-pane"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" alt="Marker" tabindex="0" role="button" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(700px, 312px, 0px); z-index: 312;"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" alt="Marker" tabindex="0" role="button" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(664px, 303px, 0px); z-index: 303;"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" alt="Marker" tabindex="0" role="button" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(678px, 337px, 0px); z-index: 337;"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" alt="Marker" tabindex="0" role="button" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(691px, 346px, 0px); z-index: 346;"><img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" alt="Marker" tabindex="0" role="button" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(689px, 334px, 0px); z-index: 334;"><div class="leaflet-marker-icon current-location-marker leaflet-zoom-animated leaflet-interactive" tabindex="0" role="button" style="margin-left: -10px; margin-top: -10px; width: 20px; height: 20px; transform: translate3d(863px, 224px, 0px); z-index: 224;"></div></div><div class="leaflet-pane leaflet-tooltip-pane"></div><div class="leaflet-pane leaflet-popup-pane"></div><div class="leaflet-proxy leaflet-zoom-animated" style="transform: translate3d(931424px, 412898px, 0px) scale(2048);"></div></div><div class="leaflet-control-container"><div class="leaflet-top leaflet-left"><div class="leaflet-control-zoom leaflet-bar leaflet-control"><a class="leaflet-control-zoom-in" href="#" title="Zoom in" role="button" aria-label="Zoom in" aria-disabled="false"><span aria-hidden="true">+</span></a><a class="leaflet-control-zoom-out" href="#" title="Zoom out" role="button" aria-label="Zoom out" aria-disabled="false"><span aria-hidden="true">‚àí</span></a></div></div><div class="leaflet-top leaflet-right"></div><div class="leaflet-bottom leaflet-left"></div><div class="leaflet-bottom leaflet-right"><div class="leaflet-control-attribution leaflet-control"><a href="https://leafletjs.com" title="A JavaScript library for interactive maps"><svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8" class="leaflet-attribution-flag"><path fill="#4C7BE1" d="M0 0h12v4H0z"></path><path fill="#FFD500" d="M0 4h12v3H0z"></path><path fill="#E0BC00" d="M0 7h12v1H0z"></path></svg> Leaflet</a> <span aria-hidden="true">|</span> ¬© OpenStreetMap contributors</div></div></div></div>
        </div>

        <div class="bottom-panel" id="bottomPanel">
            <div class="panel-header" onclick="togglePanel()">
                <div class="panel-title">Ëøë„Åè„ÅÆ„Éà„Ç§„É¨</div>
                <div class="expand-icon">‚ñ≤</div>
            </div>
            <div class="filter-panel" id="filterPanel" style="display: none;">
                <div class="filter-title">„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö</div>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterBabyBed" onchange="applyFilters()">
                        <label for="filterBabyBed">„Éô„Éì„Éº„Éô„ÉÉ„Éâ</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterMultipurpose" onchange="applyFilters()">
                        <label for="filterMultipurpose">Â§öÁõÆÁöÑ„Éà„Ç§„É¨</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterOstomy" onchange="applyFilters()">
                        <label for="filterOstomy">„Ç™„Çπ„Éà„É°„Ç§„Éà</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterHandDryer" onchange="applyFilters()">
                        <label for="filterHandDryer">„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº</label>
                    </div>
                </div>
            </div>
            <div class="toilet-list" id="toiletList">
                <div class="toilet-item" onclick="showToiletDetail(1)">
                    <div class="toilet-name">Êù±‰∫¨ÈßÖ‰∏∏„ÅÆÂÜÖÂçóÂè£„Éà„Ç§„É¨</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            5732m„ÉªÂæíÊ≠©72ÂàÜ
                        </div>
                        <div class="rating">
                            <span class="star">‚òÖ</span>
                            <span>4.2</span>
                        </div>
                    </div>
                    <div class="facilities">
                        <span class="facility-tag">„Éô„Éì„Éº„Éô„ÉÉ„Éâ</span><span class="facility-tag">Â§öÁõÆÁöÑ„Éà„Ç§„É¨</span><span class="facility-tag">„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº</span><span class="facility-tag">ËªäÊ§ÖÂ≠êÂØæÂøú</span>
                    </div>
                </div>
            
                <div class="toilet-item" onclick="showToiletDetail(5)">
                    <div class="toilet-name">ÊúâÊ•ΩÁî∫ÈßÖÂâç„Éà„Ç§„É¨</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            6379m„ÉªÂæíÊ≠©80ÂàÜ
                        </div>
                        <div class="rating">
                            <span class="star">‚òÖ</span>
                            <span>3.5</span>
                        </div>
                    </div>
                    <div class="facilities">
                        <span class="facility-tag">Â§öÁõÆÁöÑ„Éà„Ç§„É¨</span><span class="facility-tag">„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº</span>
                    </div>
                </div>
            
                <div class="toilet-item" onclick="showToiletDetail(4)">
                    <div class="toilet-name">ÈäÄÂ∫ß‰∏âË∂ä„Éà„Ç§„É¨</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            6524m„ÉªÂæíÊ≠©82ÂàÜ
                        </div>
                        <div class="rating">
                            <span class="star">‚òÖ</span>
                            <span>4.5</span>
                        </div>
                    </div>
                    <div class="facilities">
                        <span class="facility-tag">„Éô„Éì„Éº„Éô„ÉÉ„Éâ</span><span class="facility-tag">Â§öÁõÆÁöÑ„Éà„Ç§„É¨</span><span class="facility-tag">„Ç™„Çπ„Éà„É°„Ç§„Éà</span><span class="facility-tag">„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº</span><span class="facility-tag">„Ç¶„Ç©„Ç∑„É•„É¨„ÉÉ„Éà</span>
                    </div>
                </div>
            
                <div class="toilet-item" onclick="showToiletDetail(2)">
                    <div class="toilet-name">ÁöáÂ±ÖÂ§ñËãëÂÖ¨Ë°Ü„Éà„Ç§„É¨</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            6618m„ÉªÂæíÊ≠©83ÂàÜ
                        </div>
                        <div class="rating">
                            <span class="star">‚òÖ</span>
                            <span>3.8</span>
                        </div>
                    </div>
                    <div class="facilities">
                        <span class="facility-tag">Â§öÁõÆÁöÑ„Éà„Ç§„É¨</span><span class="facility-tag">ËªäÊ§ÖÂ≠êÂØæÂøú</span>
                    </div>
                </div>
            
                <div class="toilet-item" onclick="showToiletDetail(3)">
                    <div class="toilet-name">Êó•ÊØîË∞∑ÂÖ¨Âúí„Éà„Ç§„É¨</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            6717m„ÉªÂæíÊ≠©84ÂàÜ
                        </div>
                        <div class="rating">
                            <span class="star">‚òÖ</span>
                            <span>4.0</span>
                        </div>
                    </div>
                    <div class="facilities">
                        <span class="facility-tag">„Éô„Éì„Éº„Éô„ÉÉ„Éâ</span><span class="facility-tag">„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº</span><span class="facility-tag">„Ç¶„Ç©„Ç∑„É•„É¨„ÉÉ„Éà</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Êñ∞Ë¶èÁôªÈå≤„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Êñ∞„Åó„ÅÑ„Éà„Ç§„É¨„ÇíÁôªÈå≤</div>
                <button class="close-btn" onclick="closeRegisterModal()">√ó</button>
            </div>
            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label">„Éà„Ç§„É¨ÂêçÁß∞</label>
                    <input type="text" class="form-input" id="toiletName" placeholder="‰æãÔºö‚óã‚óãÈßÖÊßãÂÜÖ„Éà„Ç§„É¨" required="">
                </div>
                <div class="form-group">
                    <label class="form-label">‰ΩèÊâÄ</label>
                    <input type="text" class="form-input" id="toiletAddress" placeholder="‰ΩèÊâÄ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
                </div>
                <div class="form-group">
                    <label class="form-label">Ë®≠ÂÇô</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="regBabyBed">
                            <label for="regBabyBed">„Éô„Éì„Éº„Éô„ÉÉ„Éâ</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="regMultipurpose">
                            <label for="regMultipurpose">Â§öÁõÆÁöÑ„Éà„Ç§„É¨</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="regOstomy">
                            <label for="regOstomy">„Ç™„Çπ„Éà„É°„Ç§„Éà</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="regHandDryer">
                            <label for="regHandDryer">„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="regWheelchair">
                            <label for="regWheelchair">ËªäÊ§ÖÂ≠êÂØæÂøú</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="regBidet">
                            <label for="regBidet">„Ç¶„Ç©„Ç∑„É•„É¨„ÉÉ„Éà</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Ê∏ÖÊΩîÂ∫¶Ë©ï‰æ°</label>
                    <div class="rating-input" id="cleanlinessRating">
                        <span class="rating-star" data-rating="1">‚òÖ</span>
                        <span class="rating-star" data-rating="2">‚òÖ</span>
                        <span class="rating-star" data-rating="3">‚òÖ</span>
                        <span class="rating-star" data-rating="4">‚òÖ</span>
                        <span class="rating-star" data-rating="5">‚òÖ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">„Ç≥„É°„É≥„ÉàÔºà‰ªªÊÑèÔºâ</label>
                    <textarea class="form-input" id="toiletComment" rows="3" placeholder="„Éà„Ç§„É¨„ÅÆÁä∂Ê≥Å„ÇÑÁâπÂæ¥„Çí„ÅäËÅû„Åã„Åõ„Åè„Å†„Åï„ÅÑ"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
                    ÁôªÈå≤„Åô„Çã
                </button>
            </form>
        </div>
    </div>

    <!-- „Éà„Ç§„É¨Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="detailTitle">„Éà„Ç§„É¨Ë©≥Á¥∞</div>
                <button class="close-btn" onclick="closeDetailModal()">√ó</button>
            </div>
            <div id="detailContent">
                <!-- „Éà„Ç§„É¨Ë©≥Á¥∞„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
            </div>
        </div>
    </div>

    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let map;
        let currentLocationMarker;
        let currentPosition = null;
        let toiletMarkers = [];
        let toilets = [];
        let tempMarker = null;
        let selectedRating = 0;

        // ‚òÖ add: Âú∞Âõ≥„ÅÆ bbox „Åã„Çâ amenity=toilets „ÇíÂèñ„Å£„Å¶„Åè„Çã
        async function pullToiletsFromOSM() {
            // ÁîªÈù¢„Å´Êò†„Å£„Å¶„ÅÑ„ÇãÁØÑÂõ≤„Çí bbox ÊñáÂ≠óÂàóÔºàÂçó,Ë•ø,Âåó,Êù±Ôºâ„Å´
            const b = map.getBounds();
            const bbox = `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`;
            

            // OverpassQL
            const query = `
            [out:json][timeout:25];
            (
                node["amenity"="toilets"](${bbox});
                way["amenity"="toilets"](${bbox});
                relation["amenity"="toilets"](${bbox});
            );
            out center;`;

            const url  = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);
            console.log(url);
            const res  = await fetch(url);
            const data = await res.json();

            // OSM ‚Üí Êó¢Â≠ò„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Å´Â§âÊèõ
            return data.elements.map((el) => {
                const lat  = el.lat ?? el.center?.lat;
                const lng  = el.lon ?? el.center?.lon;
                const tags = el.tags ?? {};
                console.log(tags);

                return {
                    id:   el.id,
                    name: tags.name ?? 'ÂÖ¨ÂÖ±„Éà„Ç§„É¨',
                    lat, lng,
                    address: tags['full'] || tags['street'] || '‰ΩèÊâÄ‰∏çÊòé',
                    facilities: [
                        ...(tags.changing_table        === 'yes' ? ['„Éô„Éì„Éº„Éô„ÉÉ„Éâ']      : []),
                        ...(tags['wheelchair'] === 'yes' ? ['Â§öÁõÆÁöÑ„Éà„Ç§„É¨']     : []),
                        ...(tags['ostomy']     === 'yes' ? ['„Ç™„Çπ„Éà„É°„Ç§„Éà']     : []),
                        ...(tags.hand_dryer            === 'yes' ? ['„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº'] : [])
                    ],
                    rating:      3.0,   // OSM „Å´„ÅØË©ï‰æ°„ÅåÁÑ°„ÅÑ„ÅÆ„Åß„Éá„Éï„Ç©„É´„Éà
                    cleanliness: 3,
                    comments:    []
                };
            });
        }


        // „Çµ„É≥„Éó„É´„Éá„Éº„Çø
        const sampleToilets = [
            {
                id: 1,
                name: "Êù±‰∫¨ÈßÖ‰∏∏„ÅÆÂÜÖÂçóÂè£„Éà„Ç§„É¨",
                lat: 35.6812,
                lng: 139.7671,
                address: "Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫‰∏∏„ÅÆÂÜÖ1-9-1",
                facilities: ["„Éô„Éì„Éº„Éô„ÉÉ„Éâ", "Â§öÁõÆÁöÑ„Éà„Ç§„É¨", "„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº", "ËªäÊ§ÖÂ≠êÂØæÂøú"],
                rating: 4.2,
                cleanliness: 4,
                comments: ["Ê∏ÖÊΩî„Åß‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑ", "Ê∑∑Èõë„Åó„Å¶„ÅÑ„ÇãÊôÇÈñìÂ∏Ø„Åå„ÅÇ„Çã"]
            },
            {
                id: 2,
                name: "ÁöáÂ±ÖÂ§ñËãëÂÖ¨Ë°Ü„Éà„Ç§„É¨",
                lat: 35.6838,
                lng: 139.7548,
                address: "Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫ÁöáÂ±ÖÂ§ñËãë",
                facilities: ["Â§öÁõÆÁöÑ„Éà„Ç§„É¨", "ËªäÊ§ÖÂ≠êÂØæÂøú"],
                rating: 3.8,
                cleanliness: 3,
                comments: ["ÊôØËâ≤„ÅåËâØ„ÅÑÂ†¥ÊâÄ„Å´„ÅÇ„Çã"]
            },
            {
                id: 3,
                name: "Êó•ÊØîË∞∑ÂÖ¨Âúí„Éà„Ç§„É¨",
                lat: 35.6743,
                lng: 139.7594,
                address: "Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫Êó•ÊØîË∞∑ÂÖ¨Âúí1-6",
                facilities: ["„Éô„Éì„Éº„Éô„ÉÉ„Éâ", "„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº", "„Ç¶„Ç©„Ç∑„É•„É¨„ÉÉ„Éà"],
                rating: 4.0,
                cleanliness: 4,
                comments: ["ÂÖ¨ÂúíÂÜÖ„Åß‰æøÂà©", "Ê∏ÖÊΩî„Å´‰øù„Åü„Çå„Å¶„ÅÑ„Çã"]
            },
            {
                id: 4,
                name: "ÈäÄÂ∫ß‰∏âË∂ä„Éà„Ç§„É¨",
                lat: 35.6719,
                lng: 139.7639,
                address: "Êù±‰∫¨ÈÉΩ‰∏≠Â§ÆÂå∫ÈäÄÂ∫ß4-6-16",
                facilities: ["„Éô„Éì„Éº„Éô„ÉÉ„Éâ", "Â§öÁõÆÁöÑ„Éà„Ç§„É¨", "„Ç™„Çπ„Éà„É°„Ç§„Éà", "„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº", "„Ç¶„Ç©„Ç∑„É•„É¨„ÉÉ„Éà"],
                rating: 4.5,
                cleanliness: 5,
                comments: ["„Å®„Å¶„ÇÇÊ∏ÖÊΩî", "Ë®≠ÂÇô„ÅåÂÖÖÂÆü„Åó„Å¶„ÅÑ„Çã"]
            },
            {
                id: 5,
                name: "ÊúâÊ•ΩÁî∫ÈßÖÂâç„Éà„Ç§„É¨",
                lat: 35.6751,
                lng: 139.7632,
                address: "Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫ÊúâÊ•ΩÁî∫2-7-1",
                facilities: ["Â§öÁõÆÁöÑ„Éà„Ç§„É¨", "„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº"],
                rating: 3.5,
                cleanliness: 3,
                comments: ["ÈßÖÂâç„Åß‰æøÂà©", "Ê∑∑Èõë„Åô„Çã„Åì„Å®„Åå„ÅÇ„Çã"]
            }
        ];


        
        // ÂàùÊúüÂåñ
        async function initMap() {
            // Âú∞Âõ≥„ÅÆÂàùÊúüÂåñÔºàÊù±‰∫¨ÈßÖ„Çí‰∏≠ÂøÉ„Å´Ôºâ
            map = L.map('map').setView([35.6812, 139.7671], 15);

            // OpenStreetMap„Çø„Ç§„É´„É¨„Ç§„É§„Éº„ÅÆËøΩÂä†
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);


            // ‚òÖ ÊúÄÂàù„ÅÆË™≠„ÅøËæº„Åø
            toilets = await pullToiletsFromOSM();
            addToiletMarkers();
            updateNearbyToilets();

                // ‚òÖ Âú∞Âõ≥ÁßªÂãï„Åî„Å®„Å´ÂÜçÂèñÂæóÔºàÈÄ£Á∂öÂëº„Å≥Âá∫„ÅóÈò≤Ê≠¢„Å™„Çâ debounce „Åô„ÇãÔºâ
            map.on('moveend', async () => {
                toilets = await pullToiletsFromOSM();
                addToiletMarkers();
                updateNearbyToilets();
            });

            // „Çµ„É≥„Éó„É´„Éá„Éº„Çø„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË™≠„ÅøËæº„Åø„ÄÅ„Å™„Åë„Çå„Å∞„Çµ„É≥„Éó„É´„Éá„Éº„Çø„Çí‰ΩøÁî®
            const savedToilets = localStorage.getItem('toilets');
            if (savedToilets) {
                toilets = JSON.parse(savedToilets);
            } else {
                toilets = [...sampleToilets];
                saveToilets();
            }

            // „Éà„Ç§„É¨„Éû„Éº„Ç´„Éº„ÇíÂú∞Âõ≥„Å´ËøΩÂä†
            addToiletMarkers();

            // Âú∞Âõ≥„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            map.on('click', onMapClick);

            // ÁèæÂú®Âú∞„ÇíÂèñÂæóÔºà„Ç®„É©„Éº„Åß„ÇÇ„Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆ„ÇíË®≠ÂÆöÔºâ
            setTimeout(() => {
                getCurrentLocation();
            }, 500);
        }

        // ÁèæÂú®Âú∞ÂèñÂæó
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\n„Éá„É¢Áî®„Å´Êù±‰∫¨ÈßÖÂë®Ëæ∫„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ');
                setDefaultLocation();
                return;
            }

            showLoading();
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    hideLoading();
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // ÁèæÂú®Âú∞„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
                    if (currentLocationMarker) {
                        map.removeLayer(currentLocationMarker);
                    }
                    
                    const currentLocationIcon = L.divIcon({
                        className: 'current-location-marker',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    currentLocationMarker = L.marker([currentPosition.lat, currentPosition.lng], {
                        icon: currentLocationIcon
                    }).addTo(map);
                    
                    // Âú∞Âõ≥„ÇíÁèæÂú®Âú∞„Å´ÁßªÂãï
                    map.setView([currentPosition.lat, currentPosition.lng], 16);
                    
                    // Ëøë„Åè„ÅÆ„Éà„Ç§„É¨„ÇíÊõ¥Êñ∞
                    updateNearbyToilets();
                },
                (error) => {
                    hideLoading();
                    let errorMessage = '';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "‰ΩçÁΩÆÊÉÖÂ†±„ÅÆ‰ΩøÁî®„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ\n„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åß‰ΩçÁΩÆÊÉÖÂ†±„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„Éá„É¢Áî®„Å´Êù±‰∫¨ÈßÖÂë®Ëæ∫„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\n„Éá„É¢Áî®„Å´Êù±‰∫¨ÈßÖÂë®Ëæ∫„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ\n„Éá„É¢Áî®„Å´Êù±‰∫¨ÈßÖÂë®Ëæ∫„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ";
                            break;
                        default:
                            errorMessage = "‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ\n„Éá„É¢Áî®„Å´Êù±‰∫¨ÈßÖÂë®Ëæ∫„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ";
                            break;
                    }
                    
                    alert(errorMessage);
                    console.error('‰ΩçÁΩÆÊÉÖÂ†±„Ç®„É©„Éº:', error);
                    setDefaultLocation();
                },
                options
            );
        }

        // „Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆ„ÇíË®≠ÂÆöÔºàÊù±‰∫¨ÈßÖÔºâ
        function setDefaultLocation() {
            currentPosition = {
                lat: 35.6812,
                lng: 139.7671
            };
            
            // „Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆ„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            
            const defaultLocationIcon = L.divIcon({
                className: 'current-location-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                html: '<div style="background: #f56565; width: 20px; height: 20px; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);"></div>'
            });
            
            currentLocationMarker = L.marker([currentPosition.lat, currentPosition.lng], {
                icon: defaultLocationIcon
            }).addTo(map);
            
            currentLocationMarker.bindPopup("„Éá„É¢‰ΩçÁΩÆÔºàÊù±‰∫¨ÈßÖÔºâ").openPopup();
            
            // Âú∞Âõ≥„Çí„Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆ„Å´ÁßªÂãï
            map.setView([currentPosition.lat, currentPosition.lng], 16);
            
            // Ëøë„Åè„ÅÆ„Éà„Ç§„É¨„ÇíÊõ¥Êñ∞
            updateNearbyToilets();
        }

        // „Éà„Ç§„É¨„Éû„Éº„Ç´„Éº„ÇíÂú∞Âõ≥„Å´ËøΩÂä†
        function addToiletMarkers() {
            // Êó¢Â≠ò„ÅÆ„Éû„Éº„Ç´„Éº„ÇíÂâäÈô§
            toiletMarkers.forEach(marker => map.removeLayer(marker));
            toiletMarkers = [];

            // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
            const filteredToilets = getFilteredToilets();

            filteredToilets.forEach(toilet => {
                const marker = L.marker([toilet.lat, toilet.lng]).addTo(map);
                
                // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆË®≠ÂÆö
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 8px 0; color: #2d3748;">${toilet.name}</h3>
                        <p style="margin: 0 0 8px 0; color: #718096; font-size: 14px;">${toilet.address}</p>
                        <div style="margin-bottom: 8px;">
                            <span style="color: #fbbf24;">‚òÖ</span> ${toilet.rating.toFixed(1)}
                        </div>
                        <div style="margin-bottom: 12px;">
                            ${toilet.facilities.map(f => `<span style="background: #e2e8f0; color: #4a5568; padding: 2px 6px; border-radius: 8px; font-size: 12px; margin-right: 4px;">${f}</span>`).join('')}
                        </div>
                        <button onclick="showToiletDetail(${toilet.id})" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; width: 100%;">Ë©≥Á¥∞„ÇíË¶ã„Çã</button>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                toiletMarkers.push(marker);
            });
        }

        // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
        function getFilteredToilets() {
            const filters = {
                babyBed: document.getElementById('filterBabyBed').checked,
                multipurpose: document.getElementById('filterMultipurpose').checked,
                ostomy: document.getElementById('filterOstomy').checked,
                handDryer: document.getElementById('filterHandDryer').checked
            };

            return toilets.filter(toilet => {
                if (filters.babyBed && !toilet.facilities.includes('„Éô„Éì„Éº„Éô„ÉÉ„Éâ')) return false;
                if (filters.multipurpose && !toilet.facilities.includes('Â§öÁõÆÁöÑ„Éà„Ç§„É¨')) return false;
                if (filters.ostomy && !toilet.facilities.includes('„Ç™„Çπ„Éà„É°„Ç§„Éà')) return false;
                if (filters.handDryer && !toilet.facilities.includes('„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº')) return false;
                return true;
            });
        }

        // Ëøë„Åè„ÅÆ„Éà„Ç§„É¨„ÇíÊõ¥Êñ∞
        function updateNearbyToilets() {
            // ÁèæÂú®‰ΩçÁΩÆ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂÖ®„Å¶„ÅÆ„Éà„Ç§„É¨„ÇíË°®Á§∫
            if (!currentPosition) {
                const filteredToilets = getFilteredToilets();
                displayToiletList(filteredToilets.slice(0, 5));
                return;
            }

            const filteredToilets = getFilteredToilets();
            
            // Ë∑ùÈõ¢„ÇíË®àÁÆó
            const toiletsWithDistance = filteredToilets.map(toilet => {
                const distance = calculateDistance(
                    currentPosition.lat, currentPosition.lng,
                    toilet.lat, toilet.lng
                );
                return {
                    ...toilet,
                    distance: distance,
                    walkingTime: Math.ceil(distance / 80) // ÊôÇÈÄü4.8kmÔºà80m/ÂàÜÔºâ„ÅßË®àÁÆó
                };
            });

            // Ë∑ùÈõ¢„Åß„ÇΩ„Éº„Éà
            toiletsWithDistance.sort((a, b) => a.distance - b.distance);

            // 500m‰ª•ÂÜÖ„ÅÆ„Éà„Ç§„É¨„ÄÅ„Åæ„Åü„ÅØÊúÄ‰Ωé5ÂÄã„ÅÆ„Éà„Ç§„É¨„ÇíË°®Á§∫
            const nearbyToilets = toiletsWithDistance.filter(t => t.distance <= 500);
            const displayToilets = nearbyToilets.length >= 5 ? nearbyToilets : toiletsWithDistance.slice(0, 5);

            displayToiletList(displayToilets);
        }

        // „Éà„Ç§„É¨„É™„Çπ„Éà„ÇíË°®Á§∫
        function displayToiletList(toilets) {
            const toiletList = document.getElementById('toiletList');
            
            if (toilets.length === 0) {
                toiletList.innerHTML = '<p style="text-align: center; color: #718096;">Ëøë„Åè„Å´„Éà„Ç§„É¨„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>';
                return;
            }

            toiletList.innerHTML = toilets.map(toilet => `
                <div class="toilet-item" onclick="showToiletDetail(${toilet.id})">
                    <div class="toilet-name">${toilet.name}</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            ${toilet.distance ? `${toilet.distance}m„ÉªÂæíÊ≠©${toilet.walkingTime}ÂàÜ` : ''}
                        </div>
                        <div class="rating">
                            <span class="star">‚òÖ</span>
                            <span>${toilet.rating.toFixed(1)}</span>
                        </div>
                    </div>
                    <div class="facilities">
                        ${toilet.facilities.map(facility => `<span class="facility-tag">${facility}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Ë∑ùÈõ¢Ë®àÁÆóÔºàHaversineÂÖ¨ÂºèÔºâ
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Âú∞ÁêÉ„ÅÆÂçäÂæÑÔºà„É°„Éº„Éà„É´Ôºâ
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return Math.round(R * c);
        }

        // „Éë„Éç„É´„ÅÆÈñãÈñâ
        function togglePanel() {
            const panel = document.getElementById('bottomPanel');
            panel.classList.toggle('expanded');
        }

        // „Éï„Ç£„É´„Çø„Éº„ÅÆË°®Á§∫/ÈùûË°®Á§∫
        function toggleFilters() {
            const filterPanel = document.getElementById('filterPanel');
            filterPanel.style.display = filterPanel.style.display === 'none' ? 'block' : 'none';
        }

        // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
        function applyFilters() {
            addToiletMarkers();
            updateNearbyToilets();
        }

        // Âú∞Âõ≥„ÇØ„É™„ÉÉ„ÇØ
        function onMapClick(e) {
            // Êñ∞Ë¶èÁôªÈå≤„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅÆ„ÅøÂá¶ÁêÜ
            if (document.getElementById('registerModal').classList.contains('active')) {
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }
                tempMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
            }
        }

        // Êñ∞Ë¶èÁôªÈå≤„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openRegisterModal() {
            document.getElementById('registerModal').classList.add('active');
            // Ë©ï‰æ°„ÅÆÂàùÊúüÂåñ
            selectedRating = 0;
            updateRatingDisplay();
        }

        // Êñ∞Ë¶èÁôªÈå≤„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('active');
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
            document.getElementById('registerForm').reset();
            selectedRating = 0;
            updateRatingDisplay();
        }

        // „Éà„Ç§„É¨Ë©≥Á¥∞„ÇíË°®Á§∫
        function showToiletDetail(toiletId) {
            const toilet = toilets.find(t => t.id === toiletId);
            if (!toilet) return;

            document.getElementById('detailTitle').textContent = toilet.name;
            
            const distance = currentPosition ? calculateDistance(
                currentPosition.lat, currentPosition.lng,
                toilet.lat, toilet.lng
            ) : null;
            
            const walkingTime = distance ? Math.ceil(distance / 80) : null;

            document.getElementById('detailContent').innerHTML = `
                <div style="margin-bottom: 16px;">
                    <h3 style="color: #2d3748; margin-bottom: 8px;">Âü∫Êú¨ÊÉÖÂ†±</h3>
                    <p><strong>‰ΩèÊâÄ:</strong> ${toilet.address}</p>
                    ${distance ? `<p><strong>Ë∑ùÈõ¢:</strong> ${distance}mÔºàÂæíÊ≠©Á¥Ñ${walkingTime}ÂàÜÔºâ</p>` : ''}
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                        <span style="color: #fbbf24; font-size: 18px;">‚òÖ</span>
                        <span style="font-size: 16px; font-weight: 600;">${toilet.rating.toFixed(1)}</span>
                        <span style="color: #718096;">ÔºàÊ∏ÖÊΩîÂ∫¶: ${toilet.cleanliness}/5Ôºâ</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <h3 style="color: #2d3748; margin-bottom: 8px;">Ë®≠ÂÇô</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${toilet.facilities.map(facility => `
                            <span style="background: #e2e8f0; color: #4a5568; padding: 6px 12px; border-radius: 12px; font-size: 14px;">
                                ${facility}
                            </span>
                        `).join('')}
                    </div>
                </div>
                
                ${toilet.comments && toilet.comments.length > 0 ? `
                    <div style="margin-bottom: 16px;">
                        <h3 style="color: #2d3748; margin-bottom: 8px;">„Ç≥„É°„É≥„Éà</h3>
                        ${toilet.comments.map(comment => `
                            <div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #667eea;">
                                ${comment}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div style="display: flex; gap: 8px; margin-top: 20px;">
                    <button onclick="openNavigationApp(${toilet.lat}, ${toilet.lng})" 
                            style="flex: 1; background: #48bb78; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        üß≠ „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
                    </button>
                    <button onclick="reportIssue(${toilet.id})" 
                            style="flex: 1; background: #ed8936; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        ‚ö†Ô∏è ÂïèÈ°å„ÇíÂ†±Âëä
                    </button>
                </div>
            `;
            
            document.getElementById('detailModal').classList.add('active');
        }

        // „Éà„Ç§„É¨Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Ç¢„Éó„É™„ÇíÈñã„Åè
        function openNavigationApp(lat, lng) {
            // Google Maps„ÅßÈñã„Åè
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }

        // ÂïèÈ°å„ÇíÂ†±Âëä
        function reportIssue(toiletId) {
            const issues = [
                '„Éà„Ç§„É¨„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ',
                '„Éà„Ç§„É¨„Åå‰ΩøÁî®„Åß„Åç„Å™„ÅÑ',
                '„Éô„Éì„Éº„Éô„ÉÉ„Éâ„Åå„Å™„ÅÑ/ÊïÖÈöú',
                '„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº„ÅåÊïÖÈöú',
                'Ê∏ÖÊΩîÂ∫¶„Åå‰Ωé„ÅÑ',
                '„Åù„ÅÆ‰ªñ„ÅÆÂïèÈ°å'
            ];
            
            const selectedIssue = prompt(`Â†±Âëä„Åô„ÇãÂïèÈ°å„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ:\n${issues.map((issue, index) => `${index + 1}. ${issue}`).join('\n')}\n\nÁï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (1-${issues.length}):`);
            
            if (selectedIssue && selectedIssue >= 1 && selectedIssue <= issues.length) {
                alert(`„Äå${issues[selectedIssue - 1]}„Äç„ÅÆÂ†±Âëä„ÇíÂèó„Åë‰ªò„Åë„Åæ„Åó„Åü„ÄÇ„ÅîÂçîÂäõ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ`);
                // ÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Åß„ÅØ„ÄÅ„Åì„Åì„Åß„Çµ„Éº„Éê„Éº„Å´Â†±Âëä„ÇíÈÄÅ‰ø°
            }
        }

        // Ë©ï‰æ°Êòü„ÅÆÂá¶ÁêÜ
        document.addEventListener('DOMContentLoaded', function() {
            const ratingStars = document.querySelectorAll('.rating-star');
            ratingStars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateRatingDisplay();
                });
            });
        });

        function updateRatingDisplay() {
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach((star, index) => {
                if (index < selectedRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Âá¶ÁêÜ
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('registerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!tempMarker) {
                    alert('ÁôªÈå≤ÂÆå‰∫ÜÔºÅÔºÅÔºÅÔºÅ');
                    return;
                }
                
                const formData = new FormData(this);
                const facilities = [];
                
                // Ë®≠ÂÇôÊÉÖÂ†±„ÇíÂèñÂæó
                if (document.getElementById('regBabyBed').checked) facilities.push('„Éô„Éì„Éº„Éô„ÉÉ„Éâ');
                if (document.getElementById('regMultipurpose').checked) facilities.push('Â§öÁõÆÁöÑ„Éà„Ç§„É¨');
                if (document.getElementById('regOstomy').checked) facilities.push('„Ç™„Çπ„Éà„É°„Ç§„Éà');
                if (document.getElementById('regHandDryer').checked) facilities.push('„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº');
                if (document.getElementById('regWheelchair').checked) facilities.push('ËªäÊ§ÖÂ≠êÂØæÂøú');
                if (document.getElementById('regBidet').checked) facilities.push('„Ç¶„Ç©„Ç∑„É•„É¨„ÉÉ„Éà');
                
                const newToilet = {
                    id: Date.now(), // Á∞°ÊòìIDÁîüÊàê
                    name: document.getElementById('toiletName').value,
                    lat: tempMarker.getLatLng().lat,
                    lng: tempMarker.getLatLng().lng,
                    address: document.getElementById('toiletAddress').value || '‰ΩèÊâÄ‰∏çÊòé',
                    facilities: facilities,
                    rating: selectedRating || 3,
                    cleanliness: selectedRating || 3,
                    comments: document.getElementById('toiletComment').value ? [document.getElementById('toiletComment').value] : []
                };
                
                // „Éà„Ç§„É¨„ÇíËøΩÂä†
                toilets.push(newToilet);
                saveToilets();
                
                // Âú∞Âõ≥„ÇíÊõ¥Êñ∞
                addToiletMarkers();
                updateNearbyToilets();
                
                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                closeRegisterModal();
                
                alert('Êñ∞„Åó„ÅÑ„Éà„Ç§„É¨„ÅåÁôªÈå≤„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
            });
        });

        // „Éá„Éº„Çø„ÅÆ‰øùÂ≠ò
        function saveToilets() {
            localStorage.setItem('toilets', JSON.stringify(toilets));
        }

        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫/ÈùûË°®Á§∫
        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // ÂàùÊúüÂåñÂÆüË°å
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });

        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'registerModal') {
                    closeRegisterModal();
                } else if (e.target.id === 'detailModal') {
                    closeDetailModal();
                }
            }
        });

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('registerModal').classList.contains('active')) {
                    closeRegisterModal();
                }
                if (document.getElementById('detailModal').classList.contains('active')) {
                    closeDetailModal();
                }
            }
        });

        // „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú
        function handleResize() {
            if (map) {
                map.invalidateSize();
            }
        }

        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', function() {
            setTimeout(handleResize, 500);
        });
    </script>

</body></html>
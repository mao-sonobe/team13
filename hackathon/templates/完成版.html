<html lang="ja"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éà„Ç§„É¨„Éì„É•ÔºÅÔºÅ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow: hidden;
        }

        .app-container {
            position: relative;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .header h1 {
            color: #4a5568;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .bottom-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
            max-height: 40vh;
            overflow-y: auto;
            transform: translateY(calc(100% - 60px));
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .bottom-panel.expanded {
            transform: translateY(0);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #4a5568;
        }

        .expand-icon {
            font-size: 20px;
            color: #718096;
            transition: transform 0.3s ease;
        }

        .bottom-panel.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .toilet-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toilet-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toilet-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .toilet-name {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .toilet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .distance-time {
            color: #718096;
            font-size: 14px;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .star {
            color: #fbbf24;
            font-size: 16px;
        }

        .facilities {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .facility-tag {
            background: #e2e8f0;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .rating-input {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .rating-star {
            font-size: 24px;
            color: #e2e8f0;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .rating-star.active {
            color: #fbbf24;
        }

        .current-location-marker {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            z-index: 3000;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filter-panel {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .filter-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2d3748;
        }

        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .controls {
                gap: 8px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>üöª „Éà„Ç§„É¨„Éì„É•ÔºÅÔºÅ</h1>
            <div class="controls">
                <button class="btn btn-primary" onclick="getCurrentLocation()">
                    üìç ÁèæÂú®Âú∞
                </button>
                <button class="btn btn-secondary" onclick="openRegisterModal()">
                    ‚ûï Êñ∞Ë¶èÁôªÈå≤
                </button>
                <button class="btn btn-secondary" onclick="toggleFilters()">
                    üîç „Éï„Ç£„É´„Çø„Éº
                </button>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>

        <div class="bottom-panel" id="bottomPanel">
            <div class="panel-header" onclick="togglePanel()">
                <div class="panel-title">Ëøë„Åè„ÅÆ„Éà„Ç§„É¨</div>
                <div class="expand-icon">‚ñ≤</div>
            </div>
            <div class="filter-panel" id="filterPanel" style="display: none;">
                <div class="filter-title">„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö</div>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterBabyBed" onchange="applyFilters()">
                        <label for="filterBabyBed">„Éô„Éì„Éº„Éô„ÉÉ„Éâ</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterMultipurpose" onchange="applyFilters()">
                        <label for="filterMultipurpose">Â§öÁõÆÁöÑ„Éà„Ç§„É¨</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterOstomy" onchange="applyFilters()">
                        <label for="filterOstomy">„Ç™„Çπ„Éà„É°„Ç§„Éà</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterHandDryer" onchange="applyFilters()">
                        <label for="filterHandDryer">„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº</label>
                    </div>
                </div>
            </div>
            <div class="toilet-list" id="toiletList">
                </div>
        </div>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Êñ∞„Åó„ÅÑ„Éà„Ç§„É¨„ÇíÁôªÈå≤</div>
                <button class="close-btn" onclick="closeRegisterModal()">√ó</button>
            </div>
            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label">„Éà„Ç§„É¨ÂêçÁß∞</label>
                    <input type="text" class="form-input" id="toiletName" placeholder="‰æãÔºö‚óã‚óãÈßÖÊßãÂÜÖ„Éà„Ç§„É¨" required="">
                </div>
                <div class="form-group">
                    <label class="form-label">Á∑ØÂ∫¶</label>
                    <input type="number" step="any" class="form-input" id="toiletLat" placeholder="Âú∞Âõ≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åã„ÄÅÁ∑ØÂ∫¶„ÇíÂÖ•Âäõ" required="">
                </div>
                <div class="form-group">
                    <label class="form-label">ÁµåÂ∫¶</label>
                    <input type="number" step="any" class="form-input" id="toiletLng" placeholder="Âú∞Âõ≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åã„ÄÅÁµåÂ∫¶„ÇíÂÖ•Âäõ" required="">
                </div>
                <div class="form-group">
                    <label class="form-label">‰ΩèÊâÄÔºà‰ªªÊÑèÔºâ</label>
                    <input type="text" class="form-input" id="toiletAddress" placeholder="‰ΩèÊâÄ„Åå„Çè„Åã„Çå„Å∞ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ë®≠ÂÇô</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item"><input type="checkbox" id="regBabyBed"><label for="regBabyBed">„Éô„Éì„Éº„Éô„ÉÉ„Éâ</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="regMultipurpose"><label for="regMultipurpose">Â§öÁõÆÁöÑ„Éà„Ç§„É¨</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="regOstomy"><label for="regOstomy">„Ç™„Çπ„Éà„É°„Ç§„Éà</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="regHandDryer"><label for="regHandDryer">„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="regWheelchair"><label for="regWheelchair">ËªäÊ§ÖÂ≠êÂØæÂøú</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="regBidet"><label for="regBidet">„Ç¶„Ç©„Ç∑„É•„É¨„ÉÉ„Éà</label></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Ê∏ÖÊΩîÂ∫¶Ë©ï‰æ°</label>
                    <div class="rating-input" id="cleanlinessRating">
                        <span class="rating-star" data-rating="1">‚òÖ</span>
                        <span class="rating-star" data-rating="2">‚òÖ</span>
                        <span class="rating-star" data-rating="3">‚òÖ</span>
                        <span class="rating-star" data-rating="4">‚òÖ</span>
                        <span class="rating-star" data-rating="5">‚òÖ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">„Ç≥„É°„É≥„ÉàÔºà‰ªªÊÑèÔºâ</label>
                    <textarea class="form-input" id="toiletComment" rows="3" placeholder="„Éà„Ç§„É¨„ÅÆÁä∂Ê≥Å„ÇÑÁâπÂæ¥„Çí„ÅäËÅû„Åã„Åõ„Åè„Å†„Åï„ÅÑ"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
                    ÁôªÈå≤„Åô„Çã
                </button>
            </form>
        </div>
    </div>

    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="detailTitle">„Éà„Ç§„É¨Ë©≥Á¥∞</div>
                <button class="close-btn" onclick="closeDetailModal()">√ó</button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ ---
        let map;
        let currentLocationMarker;
        let currentPosition = null;
        let toiletMarkers = [];
        let toilets = []; // „Çµ„Éº„Éê„Éº„Å®OSM„Åã„Çâ„ÅÆ„Éà„Ç§„É¨ÊÉÖÂ†±„Çí‰øùÊåÅ
        let tempMarker = null; // Êñ∞Ë¶èÁôªÈå≤Áî®„ÅÆ‰∏ÄÊôÇ„Éû„Éº„Ç´„Éº
        let selectedRating = 0; // Êñ∞Ë¶èÁôªÈå≤ÊôÇ„ÅÆË©ï‰æ°

        // --- „Çµ„É≥„Éó„É´„Éá„Éº„ÇøÔºà„Çµ„Éº„Éê„ÉºÊé•Á∂öÂ§±ÊïóÊôÇÁî®Ôºâ ---
        const sampleToilets = [
            {id: 1, name: "Êù±‰∫¨ÈßÖ‰∏∏„ÅÆÂÜÖÂçóÂè£„Éà„Ç§„É¨", lat: 35.6812, lng: 139.7671, address: "Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫‰∏∏„ÅÆÂÜÖ1-9-1", facilities: ["„Éô„Éì„Éº„Éô„ÉÉ„Éâ", "Â§öÁõÆÁöÑ„Éà„Ç§„É¨", "„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº", "ËªäÊ§ÖÂ≠êÂØæÂøú"], rating: 4.2, cleanliness: 4, comments: ["Ê∏ÖÊΩî„Åß‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑ", "Ê∑∑Èõë„Åó„Å¶„ÅÑ„ÇãÊôÇÈñìÂ∏Ø„Åå„ÅÇ„Çã"]},
            {id: 2, name: "ÁöáÂ±ÖÂ§ñËãëÂÖ¨Ë°Ü„Éà„Ç§„É¨", lat: 35.6838, lng: 139.7548, address: "Êù±‰∫¨ÈÉΩÂçÉ‰ª£Áî∞Âå∫ÁöáÂ±ÖÂ§ñËãë", facilities: ["Â§öÁõÆÁöÑ„Éà„Ç§„É¨", "ËªäÊ§ÖÂ≠êÂØæÂøú"], rating: 3.8, cleanliness: 3, comments: ["ÊôØËâ≤„ÅåËâØ„ÅÑÂ†¥ÊâÄ„Å´„ÅÇ„Çã"]},
        ];
        
        // --- ÂàùÊúüÂåñ ---
        async function initMap() {
            map = L.map('map').setView([35.6812, 139.7671], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            await loadToiletsFromServer();

            map.on('moveend', async () => {
                const osmToilets = await pullToiletsFromOSM();
                const existingIds = new Set(toilets.map(t => t.id));
                const newToilets = osmToilets.filter(t => !existingIds.has(t.id));
                if (newToilets.length > 0) {
                    toilets.push(...newToilets);
                    addToiletMarkers();
                    updateNearbyToilets();
                }
            });

            map.on('click', onMapClick);

            setTimeout(() => {
                getCurrentLocation();
            }, 500);
        }

        // --- „Éá„Éº„ÇøÂèñÂæó ---

        // „Çµ„Éº„Éê„Éº(DB)„Åã„Çâ„Éà„Ç§„É¨ÊÉÖÂ†±„Çí„É≠„Éº„Éâ
        async function loadToiletsFromServer() {
            try {
                const res = await fetch("http://127.0.0.1:5000/api/toilets");
                if (!res.ok) throw new Error('Failed to fetch from server');
                toilets = await res.json();
            } catch (error) {
                console.error("„Çµ„Éº„Éê„Éº„Åã„Çâ„Éà„Ç§„É¨ÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü:", error);
                alert("„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Çµ„É≥„Éó„É´„Éá„Éº„Çø„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ");
                toilets = [...sampleToilets];
            }
            addToiletMarkers();
            updateNearbyToilets();
        }

        // OpenStreetMap„Åã„ÇâÂú∞Âõ≥Ë°®Á§∫ÁØÑÂõ≤„ÅÆ„Éà„Ç§„É¨ÊÉÖÂ†±„ÇíÂèñÂæó
        async function pullToiletsFromOSM() {
            const b = map.getBounds();
            const bbox = `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`;
            const query = `[out:json][timeout:25];(node["amenity"="toilets"](${bbox});way["amenity"="toilets"](${bbox});relation["amenity"="toilets"](${bbox}););out center;`;
            const url  = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                return data.elements.map(el => ({
                    id: el.id,
                    name: el.tags?.name ?? 'ÂÖ¨ÂÖ±„Éà„Ç§„É¨',
                    lat: el.lat ?? el.center?.lat,
                    lng: el.lon ?? el.center?.lon,
                    address: el.tags?.['addr:full'] || el.tags?.['addr:street'] || '‰ΩèÊâÄ‰∏çÊòé',
                    facilities: [
                        ...(el.tags?.changing_table === 'yes' ? ['„Éô„Éì„Éº„Éô„ÉÉ„Éâ'] : []),
                        ...(el.tags?.wheelchair === 'yes' ? ['Â§öÁõÆÁöÑ„Éà„Ç§„É¨'] : []),
                        ...(el.tags?.ostomy === 'yes' ? ['„Ç™„Çπ„Éà„É°„Ç§„Éà'] : []),
                        ...(el.tags?.hand_dryer === 'yes' ? ['„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº'] : [])
                    ],
                    rating: 3.0,
                    cleanliness: 3,
                    comments: []
                }));
            } catch (error) {
                console.error("OSM„Åã„Çâ„ÅÆ„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó:", error);
                return [];
            }
        }

        // --- Âú∞Âõ≥„Å®„Éû„Éº„Ç´„Éº„ÅÆÊìç‰Ωú ---

        // „Éà„Ç§„É¨„Éû„Éº„Ç´„Éº„ÇíÂú∞Âõ≥„Å´ËøΩÂä†
        function addToiletMarkers() {
            toiletMarkers.forEach(marker => map.removeLayer(marker));
            toiletMarkers = [];
            const filteredToilets = getFilteredToilets();

            filteredToilets.forEach(toilet => {
                const marker = L.marker([toilet.lat, toilet.lng]).addTo(map);
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h3 style="margin: 0 0 8px 0; color: #2d3748;">${toilet.name}</h3>
                        <p style="margin: 0 0 8px 0; color: #718096; font-size: 14px;">${toilet.address}</p>
                        <div style="margin-bottom: 8px;">
                            <span style="color: #fbbf24;">‚òÖ</span> ${toilet.rating.toFixed(1)}
                        </div>
                        <div style="margin-bottom: 12px;">
                            ${toilet.facilities.map(f => `<span style="background: #e2e8f0; color: #4a5568; padding: 2px 6px; border-radius: 8px; font-size: 12px; margin-right: 4px;">${f}</span>`).join('')}
                        </div>
                        <button onclick="showToiletDetail(${toilet.id})" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; width: 100%;">Ë©≥Á¥∞„ÇíË¶ã„Çã</button>
                    </div>`;
                marker.bindPopup(popupContent);
                toiletMarkers.push(marker);
            });
        }

        // ‚òÖ‚òÖ‚òÖ Âú∞Âõ≥„ÇØ„É™„ÉÉ„ÇØ„ÅßÁ∑ØÂ∫¶„ÉªÁµåÂ∫¶„Çí„Éï„Ç©„Éº„É†„Å´Ë®≠ÂÆö ‚òÖ‚òÖ‚òÖ
        function onMapClick(e) {
            if (document.getElementById('registerModal').classList.contains('active')) {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);
                document.getElementById('toiletLat').value = lat;
                document.getElementById('toiletLng').value = lng;
                
                if (tempMarker) {
                    tempMarker.setLatLng([lat, lng]);
                } else {
                    tempMarker = L.marker([lat, lng]).addTo(map);
                }
            }
        }

        // --- UIÊõ¥Êñ∞ ---
        
        function updateNearbyToilets() {
            if (!currentPosition) {
                displayToiletList(getFilteredToilets().slice(0, 5));
                return;
            }
            const toiletsWithDistance = getFilteredToilets().map(toilet => ({
                ...toilet,
                distance: calculateDistance(currentPosition.lat, currentPosition.lng, toilet.lat, toilet.lng)
            })).sort((a, b) => a.distance - b.distance);
            
            displayToiletList(toiletsWithDistance.slice(0, 10)); // Ëøë„Åè„ÅÆ10‰ª∂„ÇíË°®Á§∫
        }
        
        function displayToiletList(toiletsToDisplay) {
            const toiletList = document.getElementById('toiletList');
            if (toiletsToDisplay.length === 0) {
                toiletList.innerHTML = '<p style="text-align: center; color: #718096;">Ëøë„Åè„Å´„Éà„Ç§„É¨„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>';
                return;
            }
            toiletList.innerHTML = toiletsToDisplay.map(toilet => {
                const walkingTime = toilet.distance ? Math.ceil(toilet.distance / 80) : null;
                return `
                <div class="toilet-item" onclick="showToiletDetail(${toilet.id})">
                    <div class="toilet-name">${toilet.name}</div>
                    <div class="toilet-info">
                        <div class="distance-time">
                            ${toilet.distance ? `${toilet.distance}m„ÉªÂæíÊ≠©${walkingTime}ÂàÜ` : ''}
                        </div>
                        <div class="rating">
                            <span class="star">‚òÖ</span>
                            <span>${toilet.rating.toFixed(1)}</span>
                        </div>
                    </div>
                    <div class="facilities">
                        ${toilet.facilities.map(f => `<span class="facility-tag">${f}</span>`).join('')}
                    </div>
                </div>`;
            }).join('');
        }
        
        // --- „Éï„Ç£„É´„Çø„Éº ---
        function getFilteredToilets() {
            const filters = {
                babyBed: document.getElementById('filterBabyBed').checked,
                multipurpose: document.getElementById('filterMultipurpose').checked,
                ostomy: document.getElementById('filterOstomy').checked,
                handDryer: document.getElementById('filterHandDryer').checked
            };
            return toilets.filter(toilet => 
                (!filters.babyBed || toilet.facilities.includes('„Éô„Éì„Éº„Éô„ÉÉ„Éâ')) &&
                (!filters.multipurpose || toilet.facilities.includes('Â§öÁõÆÁöÑ„Éà„Ç§„É¨')) &&
                (!filters.ostomy || toilet.facilities.includes('„Ç™„Çπ„Éà„É°„Ç§„Éà')) &&
                (!filters.handDryer || toilet.facilities.includes('„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº'))
            );
        }

        function applyFilters() {
            addToiletMarkers();
            updateNearbyToilets();
        }

        // --- „É¢„Éº„ÉÄ„É´Êìç‰Ωú ---

        function openRegisterModal() {
            document.getElementById('registerModal').classList.add('active');
            selectedRating = 0;
            updateRatingDisplay();
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('active');
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
            document.getElementById('registerForm').reset();
            selectedRating = 0;
            updateRatingDisplay();
        }

        function showToiletDetail(toiletId) {
            const toilet = toilets.find(t => t.id === toiletId);
            if (!toilet) return;
            document.getElementById('detailTitle').textContent = toilet.name;
            const distance = currentPosition ? calculateDistance(currentPosition.lat, currentPosition.lng, toilet.lat, toilet.lng) : null;
            const walkingTime = distance ? Math.ceil(distance / 80) : null;
            document.getElementById('detailContent').innerHTML = `
                <div style="margin-bottom: 16px;">
                    <h3 style="color: #2d3748; margin-bottom: 8px;">Âü∫Êú¨ÊÉÖÂ†±</h3>
                    <p><strong>‰ΩèÊâÄ:</strong> ${toilet.address}</p>
                    ${distance ? `<p><strong>Ë∑ùÈõ¢:</strong> ${distance}mÔºàÂæíÊ≠©Á¥Ñ${walkingTime}ÂàÜÔºâ</p>` : ''}
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                        <span style="color: #fbbf24; font-size: 18px;">‚òÖ</span>
                        <span style="font-size: 16px; font-weight: 600;">${toilet.rating.toFixed(1)}</span>
                        <span style="color: #718096;">ÔºàÊ∏ÖÊΩîÂ∫¶: ${toilet.cleanliness}/5Ôºâ</span>
                    </div>
                </div>
                <div style="margin-bottom: 16px;">
                    <h3 style="color: #2d3748; margin-bottom: 8px;">Ë®≠ÂÇô</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${toilet.facilities.map(f => `<span style="background: #e2e8f0; color: #4a5568; padding: 6px 12px; border-radius: 12px; font-size: 14px;">${f}</span>`).join('')}
                    </div>
                </div>
                ${toilet.comments && toilet.comments.length > 0 ? `
                    <div style="margin-bottom: 16px;">
                        <h3 style="color: #2d3748; margin-bottom: 8px;">„Ç≥„É°„É≥„Éà</h3>
                        ${toilet.comments.map(comment => `<div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #667eea;">${comment}</div>`).join('')}
                    </div>` : ''}
                <div style="display: flex; gap: 8px; margin-top: 20px;">
                    <button onclick="openNavigationApp(${toilet.lat}, ${toilet.lng})" style="flex: 1; background: #48bb78; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">üß≠ „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥</button>
                    <button onclick="reportIssue(${toilet.id})" style="flex: 1; background: #ed8936; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">‚ö†Ô∏è ÂïèÈ°å„ÇíÂ†±Âëä</button>
                </div>`;
            document.getElementById('detailModal').classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
            return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }
        function togglePanel() { document.getElementById('bottomPanel').classList.toggle('expanded'); }
        function toggleFilters() { const fp = document.getElementById('filterPanel'); fp.style.display = fp.style.display === 'none' ? 'block' : 'none'; }
        function openNavigationApp(lat, lng) { window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank'); }
        function reportIssue(id) { alert(`„Éà„Ç§„É¨ID: ${id} „ÅÆÂïèÈ°åÂ†±ÂëäÊ©üËÉΩ„ÅØÁèæÂú®ÈñãÁô∫‰∏≠„Åß„Åô„ÄÇ`); }
        function showLoading() { document.getElementById('loading').classList.add('active'); }
        function hideLoading() { document.getElementById('loading').classList.remove('active'); }

        // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            // Ë©ï‰æ°Êòü„ÅÆÂá¶ÁêÜ
            document.querySelectorAll('.rating-star').forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateRatingDisplay();
                });
            });

            // ‚òÖ‚òÖ‚òÖ „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Âá¶ÁêÜ ‚òÖ‚òÖ‚òÖ
            document.getElementById('registerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const lat = document.getElementById('toiletLat').value;
                const lng = document.getElementById('toiletLng').value;

                if (!lat || !lng) {
                    alert('Âú∞Âõ≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åã„ÄÅÁ∑ØÂ∫¶„Å®ÁµåÂ∫¶„ÇíÁõ¥Êé•ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    return;
                }

                const facilities = [];
                if (document.getElementById('regBabyBed').checked) facilities.push('„Éô„Éì„Éº„Éô„ÉÉ„Éâ');
                if (document.getElementById('regMultipurpose').checked) facilities.push('Â§öÁõÆÁöÑ„Éà„Ç§„É¨');
                if (document.getElementById('regOstomy').checked) facilities.push('„Ç™„Çπ„Éà„É°„Ç§„Éà');
                if (document.getElementById('regHandDryer').checked) facilities.push('„Éè„É≥„Éâ„Éâ„É©„Ç§„É§„Éº');
                if (document.getElementById('regWheelchair').checked) facilities.push('ËªäÊ§ÖÂ≠êÂØæÂøú');
                if (document.getElementById('regBidet').checked) facilities.push('„Ç¶„Ç©„Ç∑„É•„É¨„ÉÉ„Éà');
                
                const comment = document.getElementById('toiletComment').value;

                const newToiletData = {
                    name: document.getElementById('toiletName').value,
                    lat: parseFloat(lat),
                    lng: parseFloat(lng),
                    address: document.getElementById('toiletAddress').value || '‰ΩèÊâÄ‰∏çÊòé',
                    facilities: facilities,
                    rating: selectedRating || 3.0,
                    cleanliness: selectedRating || 3,
                    comments: comment ? [comment] : []
                };

                fetch("http://127.0.0.1:5000/api/toilets", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newToiletData)
                })
                .then(res => {
                    if (!res.ok) throw new Error(`„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: ${res.statusText}`);
                    return res.json();
                })
                .then(addedToilet => {
                    toilets.push(addedToilet);
                    addToiletMarkers();
                    updateNearbyToilets();
                    closeRegisterModal();
                    alert("Êñ∞„Åó„ÅÑ„Éà„Ç§„É¨„ÅåÁôªÈå≤„Åï„Çå„Åæ„Åó„ÅüÔºÅ");
                })
                .catch(err => {
                    alert("ÁôªÈå≤‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: " + err.message);
                    console.error(err);
                });
            });
        });
        
        function updateRatingDisplay() {
            document.querySelectorAll('.rating-star').forEach((star, index) => {
                star.classList.toggle('active', index < selectedRating);
            });
        }
        
        // --- ÁèæÂú®Âú∞ÂèñÂæó ---
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }
            showLoading();
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    hideLoading();
                    currentPosition = { lat: position.coords.latitude, lng: position.coords.longitude };
                    if (currentLocationMarker) map.removeLayer(currentLocationMarker);
                    
                    const icon = L.divIcon({ className: 'current-location-marker', iconSize: [20, 20], iconAnchor: [10, 10] });
                    currentLocationMarker = L.marker([currentPosition.lat, currentPosition.lng], { icon }).addTo(map);
                    
                    map.setView([currentPosition.lat, currentPosition.lng], 16);
                    updateNearbyToilets();
                },
                (error) => {
                    hideLoading();
                    alert("‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
                    console.error('‰ΩçÁΩÆÊÉÖÂ†±„Ç®„É©„Éº:', error);
                    updateNearbyToilets();
                }
            );
        }

    </script>
</body>
</html>